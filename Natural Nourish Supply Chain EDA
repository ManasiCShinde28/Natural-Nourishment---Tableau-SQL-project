use SupplyChainAnalysis;

select * from SupplyChainAnalysisDataset;

--- Normalizing Dataset Queries 

--Manufacturing Table
select Producttype,SUM([Stock levels]) as TotalStock,SUM(Productionvolumes) AS Productionvolumes, ceiling(round(AVG([Manufacturing lead time]),2)) as Manufacturingleadtime,round(SUM([ManufacturingCosts]),2) as ManufacturingCosts ,round(SUM(Costs),2) as TotalCost
from SupplyChainAnalysisDataset
group by Producttype;


--Sales Table
select Producttype,round(SUM(Price),2) as Price,SUM([Order quantities]) as OrderQuantities,SUM(Noofproductssold) AS Noofproductssold ,round(SUM(Revenuegenerated),2) AS Revenuegenerated
from SupplyChainAnalysisDataset
group by Producttype;

--Quality Table
With CTE1 as(
select Producttype,Inspectionresults,round(AVG([Defect rates]),2) as AvgDefectRates,
ROW_NUMBER() OVER (PARTITION BY Producttype,InspectionResults order by AVG([Defect rates]) ) as rows
from SupplyChainAnalysisDataset
group by Producttype,Inspectionresults)
SELECT * FROM CTE1  --SupplyChainAnalysisDataset  --CTE1
 PIVOT
(MAX(AvgDefectRates) FOR Inspectionresults IN (Fail,Pass,Pending)) AS PivotTable;





--Manufacturing & Revenue Analysis

-- Total Stocks By Product Type
select Producttype,count(StockKeepingUnit) as CountOfStocks
from SupplyChainAnalysisDataset
group by Producttype;


--Total Costing,Price,Revenue generated by Product Type
select ProductType, round (SUM(Price),2)  as TotalPrice,round(SUM(Costs),2) as TotalCost,round(SUM(Revenuegenerated),2) as TotalRevenue
from SupplyChainAnalysisDataset 
group by Producttype;


--Total Products Sold Vs Manufactured
With CTE1 as(
select Producttype,SUM(Noofproductssold) as NoOfProductsSold,SUM(Productionvolumes) as NoOfProductsManufactured
from SupplyChainAnalysisDataset
group by Producttype)
select *,(NoOfProductsManufactured-NoOfProductsSold) as LeftOverProducts
from CTE1;

--Average Manufacturing Time per Product

Select Producttype,round(AVG([Manufacturing lead time]),2) as AvgManufacturingTime
from SupplyChainAnalysisDataset
group by Producttype;

--Average Manufacturing Cost per Product

Select Producttype,round(AVG([ManufacturingCosts]),2) as AvgManufacturingCost
from SupplyChainAnalysisDataset
group by Producttype;

--Profit Margin Per product Type
With CTE2 as(
select Producttype,round(SUM(ManufacturingCosts),2) as TotalManufacturingCosts,round(SUM(ShippingCost),2) as TotalShippingCost,round(SUM(Price),2) as TotalPriceOfProduct
from SupplyChainAnalysisDataset
group by Producttype)
Select *,(TotalPriceOfProduct-(Costs)) as ProfitMargin,
CASE WHEN(TotalPriceOfProduct-(Costs))>0 THEN 'PROFIT' 
ELSE 'LOSS' 
END as Status
from CTE2;


--Quality Analysis

--Total defects Productwise
Select Producttype,ceiling(round(SUM([Defect rates]),2)) as TotalDefects
from SupplyChainAnalysisDataset
group by Producttype;


--InspectionResults  Analysis 

Select Producttype,Inspectionresults,COUNT(Inspectionresults) as TotalInspection,
ROW_NUMBER() over (Partition by Producttype order by COUNT(Inspectionresults)) as rownumber
from SupplyChainAnalysisDataset
group by Producttype,Inspectionresults
HAVING Inspectionresults='Pass';

Select Producttype,Inspectionresults,COUNT(Inspectionresults) as TotalInspection,
ROW_NUMBER() over (Partition by Producttype order by COUNT(Inspectionresults)) as rownumber
from SupplyChainAnalysisDataset
group by Producttype,Inspectionresults
HAVING Inspectionresults='Fail';


--Order Analysis

--Total Order Quantities

select Producttype,SUM([Order quantities]) as TotalOrderedQuantities
from SupplyChainAnalysisDataset
group by Producttype;



--Shipping Analysis

--Total Shippings done by Location
Select Location,COUNT([Shipping carriers]) as TotalShipping
from SupplyChainAnalysisDataset
group by Location
order by COUNT([Shipping carriers]) desc;

--Transportation Modes by Transportation Cost
With CTE7 as
(Select Producttype,[Transportation modes], Avg(ShippingCost) as AvgShippingCost,
RANK() OVER (Partition by Producttype,[Transportation modes] order by Avg(ShippingCost) desc) as ranks
from SupplyChainAnalysisDataset
group by Producttype,[Transportation modes] )
Select * from CTE7
PIVOT
(MAX(AvgShippingCost) For [Transportation Modes] in ("Road","Rail","Sea","Air")) as Pivot Table;

--Transportation Modes by Transportation Time
With CTE7 as
(Select Producttype,[Transportation modes], Avg([Shipping times]) as AvgShippingTime,
RANK() OVER (Partition by Producttype,[Transportation modes] order by Avg([Shipping times]) desc) as ranks
from SupplyChainAnalysisDataset
group by Producttype,[Transportation modes] )
Select * from CTE7
PIVOT
(MAX(AvgShippingTime) For [Transportation Modes] in ("Road","Rail","Sea","Air")) as Pivot Table;

